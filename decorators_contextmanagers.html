

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Decorators and Context Managers &mdash; Py300 3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Py300 3.0 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Py300
          

          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Decorators and Context Managers</a><ul>
<li><a class="reference internal" href="#id1">Decorators</a><ul>
<li><a class="reference internal" href="#import-time-vs-run-time">Import Time Vs. Run Time</a></li>
<li><a class="reference internal" href="#scope">Scope</a></li>
<li><a class="reference internal" href="#callbacks">Callbacks</a></li>
<li><a class="reference internal" href="#what-if-my-decorated-function-uses-unknown-inputs">What if my decorated function uses unknown inputs?</a></li>
<li><a class="reference internal" href="#functools-library">Functools Library</a></li>
<li><a class="reference internal" href="#stacked-decorators">Stacked Decorators</a></li>
<li><a class="reference internal" href="#parameterized-decorators">Parameterized Decorators</a></li>
</ul>
</li>
<li><a class="reference internal" href="#context-managers">Context Managers</a><ul>
<li><a class="reference internal" href="#contextlib-utilities">Contextlib Utilities</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Py300</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Decorators and Context Managers</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/decorators_contextmanagers.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="decorators-and-context-managers">
<span id="decorators"></span><h1>Decorators and Context Managers<a class="headerlink" href="#decorators-and-context-managers" title="Permalink to this headline">¶</a></h1>
<p>We touched decorators and context managers in the first quarter. I recommend you review that lecture.</p>
<p><a class="reference external" href="http://uwpce-pythoncert.github.io/IntroToPython/session10.html">http://uwpce-pythoncert.github.io/IntroToPython/session10.html</a></p>
<div class="section" id="id1">
<h2>Decorators<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Because functions are first-class objects in Python, you can write functions
that take functions as arguments and/or return functions as values and you
can declare a function inside another function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>      <span class="k">def</span> <span class="nf">inner</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>          <span class="k">print</span><span class="p">(</span><span class="s1">&#39;running inner&#39;</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>      <span class="k">return</span> <span class="n">inner</span>
   <span class="o">...</span><span class="p">:</span>


<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">other_func</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">print</span><span class="p">(</span><span class="s1">&#39;running other_func&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">other_func</span><span class="p">()</span>
<span class="n">running</span> <span class="n">other_func</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">other_func</span> <span class="o">=</span> <span class="n">my_decorator</span><span class="p">(</span><span class="n">other_func</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">other_func</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">running</span> <span class="n">inner</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">other_func</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">__main__</span><span class="o">.</span><span class="n">my_decorator</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">inner</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Which is the same as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="nd">@my_decorator</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">def</span> <span class="nf">other_func</span><span class="p">():</span>
   <span class="o">...</span><span class="p">:</span>      <span class="k">print</span><span class="p">(</span><span class="s1">&#39;running other_func&#39;</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">other_func</span><span class="p">()</span>
<span class="n">running</span> <span class="n">inner</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">other_func</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">__main__</span><span class="o">.</span><span class="n">my_decorator</span><span class="o">.&lt;</span><span class="nb">locals</span><span class="o">&gt;.</span><span class="n">inner</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Decorators have the power to replace the decorated function with a different one!</p>
<div class="section" id="import-time-vs-run-time">
<h3>Import Time Vs. Run Time<a class="headerlink" href="#import-time-vs-run-time" title="Permalink to this headline">¶</a></h3>
<p>Decorators are run at import time:</p>
<p>Examples/decorators/play_with_imports.py</p>
<p>Let&#8217;s make a decorator that finds the best price for a shirt.</p>
<p>Examples/decorators/shirt_price.py</p>
</div>
<div class="section" id="scope">
<h3>Scope<a class="headerlink" href="#scope" title="Permalink to this headline">¶</a></h3>
<p>Why do decorators have a function inside another function?</p>
<p>Decorators are implemented using closures. Definition of closures from Wikipedia:</p>
<p>Operationally, a closure is a record storing a function together with an environment: a mapping associating each free variable of the function (variables that are used locally, but defined in an enclosing scope) with the value or reference to which the name was bound when the closure was created. A closure—unlike a plain function—allows the function to access those captured variables through the closure&#8217;s copies of their values or references, even when the function is invoked outside their scope.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">start_at</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">def</span> <span class="nf">increment_by</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>         <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">return</span> <span class="n">increment_by</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">closure_1</span> <span class="o">=</span> <span class="n">start_at</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">closure_2</span> <span class="o">=</span> <span class="n">start_at</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">closure_1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">5</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">start_at</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">6</span>
</pre></div>
</div>
<p>Let&#8217;s make this more explicit:</p>
<p>Example/decorators/play_with_scope.py</p>
<p>nonlocal declaration: allows you to flag a variable as a free variable even if it&#8217;s immutable.</p>
</div>
<div class="section" id="callbacks">
<h3>Callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h3>
<p>In addition to decorators, closures are also useful for callbacks.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="o">...</span><span class="p">:</span>     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;function my_callback was called with {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="k">def</span> <span class="nf">make_call</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
             <span class="c1"># do some cool stuff here, and then call the callback</span>
    <span class="o">...</span><span class="p">:</span>     <span class="n">func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="o">...</span><span class="p">:</span>     <span class="n">make_call</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">my_callback</span><span class="p">)</span>

<span class="n">function</span> <span class="n">my_callback</span> <span class="n">was</span> <span class="n">called</span> <span class="k">with</span> <span class="mi">0</span>
<span class="n">function</span> <span class="n">my_callback</span> <span class="n">was</span> <span class="n">called</span> <span class="k">with</span> <span class="mi">1</span>
<span class="n">function</span> <span class="n">my_callback</span> <span class="n">was</span> <span class="n">called</span> <span class="k">with</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="what-if-my-decorated-function-uses-unknown-inputs">
<h3>What if my decorated function uses unknown inputs?<a class="headerlink" href="#what-if-my-decorated-function-uses-unknown-inputs" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_decorate</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;{0}&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">func_wrapper</span>


<span class="nd">@p_decorate</span>
<span class="k">def</span> <span class="nf">get_fullname</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">first_name</span> <span class="o">+</span> <span class="n">last_name</span>
</pre></div>
</div>
</div>
<div class="section" id="functools-library">
<h3>Functools Library<a class="headerlink" href="#functools-library" title="Permalink to this headline">¶</a></h3>
<p>Memoize decorator we created in the first quarter is in Functools:</p>
<p><a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.lru_cache">https://docs.python.org/3/library/functools.html#functools.lru_cache</a></p>
<dl class="docutils">
<dt>Single dispatch:</dt>
<dd><ul class="first last simple">
<li>create many functions that do the same sort of thing, but based on type</li>
<li>decorator determines type, and decides which function is run</li>
</ul>
</dd>
</dl>
<p><a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.singledispatch">https://docs.python.org/3/library/functools.html#functools.singledispatch</a></p>
</div>
<div class="section" id="stacked-decorators">
<h3>Stacked Decorators<a class="headerlink" href="#stacked-decorators" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@dec1</span>
<span class="nd">@dec2</span>
<span class="k">def</span> <span class="nf">my_fun</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;my_fun&#39;</span><span class="p">)</span>

<span class="n">translates</span> <span class="n">to</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">my_fun</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;my_fun&#39;</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">dec1</span><span class="p">(</span><span class="n">dec2</span><span class="p">(</span><span class="n">my_fun</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="parameterized-decorators">
<h3>Parameterized Decorators<a class="headerlink" href="#parameterized-decorators" title="Permalink to this headline">¶</a></h3>
<p>The purpose of the outer function in the decorator is to receive the function to be decorated, adding
anything to scope that should be there before the decorated function is called.</p>
<p>The inner function runs the function being decorated, so its inputs are the same as the function being
decorated.</p>
<p>How do we add more input parameters to our decorator? Like this example from Django:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@register.filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cut&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Add yet another function in scope:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">real_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Congratulations.  You decorated a function that does something with </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">))</span>
            <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">real_decorator</span>


<span class="nd">@decorator</span><span class="p">(</span><span class="s2">&quot;arg1&quot;</span><span class="p">,</span> <span class="s2">&quot;arg2&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">print_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
<p>Last example from: <a class="reference external" href="http://scottlobdell.me/2015/04/decorators-arguments-python/">http://scottlobdell.me/2015/04/decorators-arguments-python/</a></p>
<p>Ideas for what to cover from &#8220;Fluent Python&#8221; by Luciano Ramalho, which I highly recommend.</p>
<p>Another great overview: <a class="reference external" href="https://dbader.org/blog/python-decorators">https://dbader.org/blog/python-decorators</a></p>
</div>
</div>
<div class="section" id="context-managers">
<h2>Context Managers<a class="headerlink" href="#context-managers" title="Permalink to this headline">¶</a></h2>
<p>Are kind of similar to decorators in function: they wrap a section of code so that some other code is run before and/or afterwards, and they can effect the code that is wrapped.</p>
<p>Decorators wrap functions</p>
<p>Context managers wrap small sections of code</p>
<p>Decorators are used for things like logging, enforcing access control and authentication, instrumentation and timing functions, rate-limiting, caching, etc.</p>
<p>Context managers are used to make sure a resource is released or a previous state is restored after code block</p>
<p>But, this is all fluid, and there are tools that are designed to be used as either a context manager or a decorator.</p>
<p><a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch">https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch</a></p>
<p>What makes a context manager:</p>
<ul class="simple">
<li>The with statement was designed to simplify the try/finally pattern.</li>
<li>Uses __enter__ and __exit__ for creating context manager</li>
</ul>
<p>Therefor, just like for a try/finally block, keep the code in the context manager to the minimum that needs to be there.</p>
<p>Examples/decorators/context_manager.py</p>
<div class="section" id="contextlib-utilities">
<h3>Contextlib Utilities<a class="headerlink" href="#contextlib-utilities" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.python.org/3/library/contextlib.html">https://docs.python.org/3/library/contextlib.html</a></p>
<p>especially check out:
<a class="reference external" href="https://docs.python.org/3/library/contextlib.html#examples-and-recipes">https://docs.python.org/3/library/contextlib.html#examples-and-recipes</a></p>
<p>Remember Yield can be thought of as &#8216;pause&#8217;</p>
<p>Having a try/finally (or a with block) around the yield is an unavoidable price of using &#64;contextmanager, because you never know what the users of your context manager are going to do inside their with block.  - Leonardo Rochael</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Christopher Barker, Cris Ewing, Maria McKinley, Rick Riehle.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>